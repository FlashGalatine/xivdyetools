# OPT-003: K-d Tree Built in RGB Space, Queried with Perceptual Metrics

## Impact
MEDIUM

## Category
Algorithm

## Location
- Files: `packages/core/src/services/dye/DyeDatabase.ts`, `packages/core/src/services/dye/DyeSearch.ts`

## Current Performance
The k-d tree indexes dyes in RGB space. When using perceptual matching methods (OKLAB, CIEDE2000), it first finds RGB-approximate candidates within a radius of 100 units, then re-sorts all candidates by perceptual distance. This two-step process is suboptimal:
- Some perceptually close dyes may be missed (see BUG-008)
- The re-ranking step adds O(n log n) overhead

## Bottleneck Analysis
RGB distance is a poor proxy for perceptual distance. Two colors can be 150 RGB units apart but very close in OKLAB space (and vice versa). The fixed threshold of 100 creates a search quality vs. performance trade-off.

## Proposed Optimization
Build a secondary k-d tree in OKLAB space:

```typescript
// During DyeDatabase.initialize():
const oklabPoints = dyes.map(dye => ({
  point: [dye.okL, dye.okA, dye.okB] as [number, number, number],
  data: dye,
}));
this.oklabKdTree = new KDTree(oklabPoints);
```

When matching with OKLAB, query the OKLAB tree directly â€” no re-ranking needed.

## Expected Improvement
- Eliminates the re-ranking step entirely for perceptual matching
- Guarantees optimal matches (no missed candidates)
- ~30-50% faster for OKLAB/CIEDE2000 matching

## Trade-offs
- ~2x memory for the tree structures (acceptable for 136 dyes)
- Slightly increased initialization time
