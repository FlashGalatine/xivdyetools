# [BUG-003]: Audit Log Append Mechanism Incomplete

## Severity
MEDIUM

## Type
Logic Error

## Location
- File: `apps/presets-api/src/handlers/moderation.ts`

## Description
The moderation handler stores `previous_values` when a preset is flagged or moderated. Comments describe this as an "append-only audit log," but the implementation only stores the last flagged state rather than appending to a history. If a preset goes through multiple moderation cycles (flagged → approved → re-flagged → approved), intermediate states are lost.

## Reproduction Scenario
1. User creates preset "Cool Dyes" → approved
2. Moderator flags "Cool Dyes" with reason "needs review" → `previous_values` stores original state
3. Moderator approves after editing → `previous_values` cleared or overwritten
4. Same preset is flagged again → `previous_values` now stores state from step 3, losing step 1-2 history
5. No way to see the full moderation history of the preset

## Evidence
```typescript
// previous_values stores only the current snapshot, not an append log
// No JSON array accumulation or history table
```

## Suggested Fix
```typescript
// Option A: Store as JSON array
const existingHistory = JSON.parse(preset.previous_values || '[]');
existingHistory.push({
  timestamp: new Date().toISOString(),
  action: 'flagged',
  moderator_id: moderatorId,
  reason: reason,
  snapshot: { name: preset.name, description: preset.description },
});
await db.prepare('UPDATE presets SET previous_values = ? WHERE id = ?')
  .bind(JSON.stringify(existingHistory), presetId)
  .run();

// Option B: Separate moderation_history table (better for querying)
```

## Why It's Hidden
- Most presets are moderated once and never revisited
- The loss of history only matters for edge cases (re-flagging)
- The current implementation appears to work for the simple case

---

## Verification Note — FALSE POSITIVE (2026-02-19)

**Status: Correct Design. No code changes required.**

Manual code inspection of `apps/presets-api/schema.sql` and `apps/presets-api/src/handlers/moderation.ts` confirmed:

1. **`moderation_log` table** (schema.sql) IS the proper append-only audit log — every moderation action (approve, reject, flag, unflag, revert) is `INSERT`ed with a UUID, preset_id, moderator_discord_id, action, reason, and created_at. The `/api/v1/moderation/:presetId/history` endpoint queries this table.

2. **`previous_values` column** is intentionally a single-step revert snapshot — it stores the pre-edit state when content moderation flags an edit, allowing moderators to revert to the previous version. This is correct and expected design.

The original finding incorrectly described `previous_values` as the intended audit log. The actual audit log is already correctly implemented. No changes needed.
